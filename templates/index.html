<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>HATPI</title>
    <link rel="stylesheet" href="{{ versioned_url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/png" href="/hatpi/images/favicon.png">
</head>

<body class="index-page">
    <!-- Left sidebar -->
    <div class="left-sidebar">
        <nav class="sidebar-nav">
            <a class="nav-btn active" href="/hatpi">Dates &amp; IHUs</a>
            <a class="nav-btn" href="/hatpi/lcplots">Light Curve Plots</a>
            <a class="nav-btn" href="/hatpi/skyflats_runtimes">Daily Skyflats &amp; Task Runtimes</a>
        </nav>
    </div>
    <!-- Background animation elements -->
    <div class="background-container">
        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/moon2.png" alt="">
        <div class="stars"></div>
        <div class="twinkling"></div>
    </div>

    <div class="content-wrapper">
        <div id="home-panel">
        <!-- Optional: A pill container to control IHU grid toggling -->
        <div class="pills-container">
            <div id="index-ihu-buttons" class="pill-container-unique">
                <button class="pill-button-unique active" onclick="toggleIHUView('sequential')">Sequential</button>
                <button class="pill-button-unique" onclick="toggleIHUView('actual')">Actual</button>
            </div>
        </div>

        <!-- New split container: left for Dates, right for IHU grid -->
        <div class="split-container">
            <!-- Left: Dates content -->
            <div class="left-column">
                <div class="dates-container">
                    <div class="file-list">
                        <div class="file-items-container">
                            {% for folder, creation_date in folders %}
                            <div class="file-item">
                                <div class="file-name">
                                    <a href="{{ folder }}/">{{ folder | format_folder }}</a>
                                </div>
                                <div class="file-date">{{ creation_date }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                
            </div>

            <!-- Right: IHU grid content -->
            <div class="ihu-container">
                <div id="grid-container-ihu-sequential" class="grid-container-ihu">
                    <!-- Sequential IHU grid will be rendered here -->
                </div>
                <div id="grid-container-ihu-actual" class="grid-container-ihu" style="display: none;">
                    <!-- Actual IHU grid will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Toggle Buttons for Comments and Tagged Images -->
        <div class="comments-tags-toggle">
            <button id="show-comments" class="pill-button-unique active" onclick="toggleCommentsTagged('comments')">
                Comments
            </button>
            <button id="show-tagged" class="pill-button-unique" onclick="toggleCommentsTagged('tagged')">
                Tagged Images
            </button>
        </div>

        <!-- Comments container -->
        <div id="comments-container" class="comments-container">
            {% for author, author_comments in comments_by_author|dictsort %}
            <div class="comment-card">
                <div class="card-header">
                    <h3>{{ author }}</h3>
                </div>
                <div class="card-body">
                    {% for item in author_comments %}
                    <div class="comment-item" data-comment-id="{{ item.unique_key }}">
                        <div class="comment-header">
                            {% if item.markup_true %}
                            <div class="markup-icon">{{ item.markup_true }}</div>
                            {% endif %}
                            <span class="comment-filename">
                                <a href="{{ item.file_path }}" target="_blank">
                                    {{ item.file_path | format_filename }}
                                </a>
                            </span>
                            <span class="comment-timestamp">{{ item.timestamp }}</span>
                        </div>
                        <div class="comment-body">
                            <p>{{ item.comment }}</p>
                            <button class="delete-comment-button" onclick="deleteComment('{{ item.unique_key }}')">
                                Delete
                            </button>
                        </div>
                        {% if item.flags and item.flags|length > 0 %}
                        <div class="comment-flags">
                            {% for flag in item.flags %}
                            <span class="flag">{{ flag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- New container for Tagged Images -->
        <div id="taggedImagesContainer" class="all-tagged-images-container" style="display: none;">
            <p>Loading tagged images...</p>
        </div>

        </div> <!-- end #home-panel -->
        <div id="embed-panel" class="embed-panel" style="display: none;"></div>

    </div>

    <script src="{{ versioned_url_for('static', filename='scripts.js') }}"></script>
    <script>
        // Sidebar nav in-page loading for index only
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('.left-sidebar .nav-btn');
            const homePanel = document.getElementById('home-panel');
            const embedPanel = document.getElementById('embed-panel');

            async function loadIntoEmbed(url) {
                try {
                    const resp = await fetch(url, { credentials: 'same-origin' });
                    if (!resp.ok) return false;
                    const html = await resp.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const content = doc.querySelector('.content-wrapper');
                    if (!content) return false;
                    // Extract inner content of target page
                    const fragment = document.createElement('div');
                    fragment.innerHTML = content.innerHTML;
                    // Page-specific pruning when embedded
                    if (url.includes('/lcplots')) {
                        const headerTitle = fragment.querySelector('.header h1');
                        if (headerTitle && headerTitle.parentNode) {
                            headerTitle.parentNode.removeChild(headerTitle);
                        }
                        const breadcrumb = fragment.querySelector('.breadcrumb-nav');
                        if (breadcrumb && breadcrumb.parentNode) {
                            breadcrumb.parentNode.removeChild(breadcrumb);
                        }
                        const toolbar = fragment.querySelector('.lcplots-toolbar');
                        if (toolbar && toolbar.parentNode) {
                            toolbar.parentNode.removeChild(toolbar);
                        }
                        // Remove empty header container if it has no visible content
                        const header = fragment.querySelector('.header');
                        if (header && header.textContent.trim() === '' && header.children.length === 0) {
                            header.parentNode && header.parentNode.removeChild(header);
                        }
                        // Start the Light Curve Plots embedded UX
                        renderLcplotsStart(url, fragment);
                        return true;
                    }
                    if (url.includes('/skyflats_runtimes')) {
                        // Prune page title and pills/back-to-home when embedding
                        const pageTitle = fragment.querySelector('.page-title');
                        pageTitle && pageTitle.remove();
                        const pills = fragment.querySelector('.pills-container');
                        pills && pills.remove();
                        // Use only the inner folder content container
                        const container = fragment.querySelector('.folder-content-container');
                        // Collect and re-execute inline scripts before detaching
                        const scripts = Array.from(fragment.querySelectorAll('script'));
                        scripts.forEach(s => s.parentNode && s.parentNode.removeChild(s));
                        embedPanel.innerHTML = '';
                        const shell = document.createElement('div');
                        shell.className = 'skyflats-embed-shell';
                        if (container) {
                            shell.appendChild(container);
                        } else {
                            // Fallback to fragment content if specific container not found
                            const div = document.createElement('div');
                            div.innerHTML = fragment.innerHTML;
                            shell.appendChild(div);
                        }
                        embedPanel.appendChild(shell);
                        // Re-attach scripts so functions like loadPlot/openGalleryCustom work
                        scripts.forEach(s => {
                            const ns = document.createElement('script');
                            if (s.src) {
                                ns.src = s.src;
                            } else {
                                ns.textContent = s.textContent || '';
                            }
                            document.body.appendChild(ns);
                            setTimeout(() => ns.remove(), 0);
                        });
                        return true;
                    }
                    // Collect and re-execute inline scripts
                    const scripts = Array.from(fragment.querySelectorAll('script'));
                    scripts.forEach(s => s.parentNode && s.parentNode.removeChild(s));
                    embedPanel.innerHTML = '';
                    embedPanel.appendChild(fragment);
                    // Re-attach scripts so they execute
                    scripts.forEach(s => {
                        const ns = document.createElement('script');
                        if (s.src) {
                            ns.src = s.src;
                        } else {
                            ns.textContent = s.textContent || '';
                        }
                        document.body.appendChild(ns);
                        // Clean up dynamically added script tag
                        setTimeout(() => ns.remove(), 0);
                    });
                    return true;
                } catch (e) {
                    console.error('Embed load failed:', e);
                    return false;
                }
            }

            // Embedded Light Curve Plots – Grid-first UX
            function renderLcplotsStart(url, fragment) {
                // If base lcplots URL, show IHU grid; else render the specific directory
                const basePaths = ['/hatpi/lcplots', '/hatpi/lcplots/'];
                if (basePaths.includes(url)) {
                    renderLcplotsGrid();
                } else {
                    renderLcplotsPage(url);
                }
            }
            function renderLcplotsGrid() {
                embedPanel.innerHTML = '';
                // Use the same structure/classes as the home page grid for identical layout
                const gridContainer = document.createElement('div');
                gridContainer.id = 'grid-container-ihu-sequential';
                gridContainer.className = 'grid-container-ihu';
                embedPanel.appendChild(gridContainer);

                const sequentialRowColumns = [3, 7, 8, 9, 9, 9, 8, 6, 4, 1];
                const sequentialRowColors = ["#D5A6BE", "#B4A7D6", "#CEE1F3", "#6FA7DC", "#77A5AF", "#93C47D", "#F9E499", "#F5B26B", "#E06566", "#CC4125"];
                let textIndex = 64;  // Starting text index

                for (let i = 0; i < sequentialRowColumns.length; i++) {
                    const row = document.createElement('div');
                    row.className = 'grid-row-ihu';
                    // Use the same CSS-driven sizing; set columns via var to match styles
                    row.style.setProperty('--columns', String(sequentialRowColumns[i]));
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = `repeat(${sequentialRowColumns[i]}, 45px)`;
                    row.style.justifyContent = 'center';

                    const cells = [];
                    for (let j = 0; j < sequentialRowColumns[i]; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-item-ihu';
                        cell.style.backgroundColor = sequentialRowColors[i];
                        const button = document.createElement('button');
                        button.textContent = String(textIndex);
                        (function (index) {
                            button.addEventListener('click', function () {
                                const cellNumber = index.toString().padStart(2, '0');
                                const href = `/hatpi/lcplots/ihu${cellNumber}`;
                                renderLcplotsPage(href);
                            });
                        })(textIndex);
                        cell.appendChild(button);
                        cells.unshift(cell); // prepend to mirror the sequential layout
                        textIndex--;
                    }
                    cells.forEach(cell => row.appendChild(cell));
                    gridContainer.appendChild(row);
                }
            }
            async function renderLcplotsPage(href) {
                try {
                    const resp = await fetch(href, { credentials: 'same-origin' });
                    if (!resp.ok) return;
                    const html = await resp.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const content = doc.querySelector('.content-wrapper');
                    if (!content) return;
                    const frag = document.createElement('div');
                    frag.innerHTML = content.innerHTML;
                    // Prune header/breadcrumb/toolbar when embedded
                    const header = frag.querySelector('.header'); header && header.remove();
                    const breadcrumb = frag.querySelector('.breadcrumb-nav'); breadcrumb && breadcrumb.remove();
                    const toolbar = frag.querySelector('.lcplots-toolbar'); toolbar && toolbar.remove();
                    const list = frag.querySelector('.lcplots-container');
                    if (!list) return;
                    // Embedded pruning: remove header row, size column, and Parent Directory row
                    const headerRow = list.querySelector('.file-items-header');
                    if (headerRow) headerRow.remove();
                    const sizeHeaders = list.querySelectorAll('.file-size-header');
                    sizeHeaders.forEach(el => el.remove());
                    const fileItems = Array.from(list.querySelectorAll('.file-item'));
                    fileItems.forEach(item => {
                        // Remove Parent Directory row(s)
                        const nameEl = item.querySelector('.file-name');
                        if (nameEl && /Parent Directory/i.test(nameEl.textContent || '')) {
                            item.remove();
                            return;
                        }
                        // Remove size cell and reflow to two columns
                        const sizeCell = item.querySelector('.file-size');
                        if (sizeCell && sizeCell.parentNode) {
                            sizeCell.parentNode.removeChild(sizeCell);
                        }
                        item.style.gridTemplateColumns = '3fr 1fr';
                    });
                    embedPanel.innerHTML = '';
                    // Wrap breadcrumb and list in a shell to align left edges
                    const shell = document.createElement('div');
                    shell.className = 'lcplots-embed-shell';
                    // Build breadcrumb for embedded navigation
                    const nav = document.createElement('div');
                    nav.className = 'breadcrumb-nav';
                    // Ensure we construct from the embedded href
                    const basePath = '/hatpi/lcplots';
                    // Strip origin if present
                    const hrefPath = (href || '').replace(/^https?:\/\/[^/]+/, '');
                    const relative = hrefPath.startsWith(basePath) ? hrefPath.slice(basePath.length) : '';
                    const parts = relative.split('/').filter(Boolean);
                    // Start with Home
                    const homeLink = document.createElement('a');
                    homeLink.className = 'breadcrumb-item';
                    homeLink.href = basePath;
                    homeLink.textContent = 'IHUs';
                    nav.appendChild(homeLink);
                    let accum = basePath;
                    parts.forEach((part, idx) => {
                        const sep = document.createElement('span');
                        sep.className = 'breadcrumb-separator';
                        sep.textContent = '/';
                        nav.appendChild(sep);
                        accum = accum + '/' + part;
                        if (idx === parts.length - 1) {
                            const cur = document.createElement('span');
                            cur.className = 'breadcrumb-current';
                            cur.textContent = decodeURIComponent(part);
                            nav.appendChild(cur);
                        } else {
                            const a = document.createElement('a');
                            a.className = 'breadcrumb-item';
                            a.href = accum;
                            a.textContent = decodeURIComponent(part);
                            nav.appendChild(a);
                        }
                    });
                    shell.appendChild(nav);
                    shell.appendChild(list);
                    // Build overlay gallery (created on first use)
                    let overlayEl = null;
                    let overlayImg = null;
                    let overlayCaption = null;
                    let overlayKeyHandler = null;
                    let currentIndex = 0;
                    let overlayImages = [];
                    function createOverlay() {
                        overlayEl = document.createElement('div');
                        overlayEl.className = 'lcplots-overlay';
                        // Content wrapper
                        const content = document.createElement('div');
                        content.className = 'lcplots-overlay-content';
                        // Close button
                        const closeBtn = document.createElement('button');
                        closeBtn.className = 'lcplots-overlay-close';
                        closeBtn.setAttribute('aria-label', 'Close');
                        closeBtn.textContent = '×';
                        closeBtn.addEventListener('click', closeOverlay);
                        // Prev/Next
                        const prevBtn = document.createElement('button');
                        prevBtn.className = 'lcplots-overlay-prev';
                        prevBtn.setAttribute('aria-label', 'Previous image');
                        prevBtn.textContent = '‹';
                        prevBtn.addEventListener('click', () => showAt(currentIndex - 1, overlayImages));
                        const nextBtn = document.createElement('button');
                        nextBtn.className = 'lcplots-overlay-next';
                        nextBtn.setAttribute('aria-label', 'Next image');
                        nextBtn.textContent = '›';
                        nextBtn.addEventListener('click', () => showAt(currentIndex + 1, overlayImages));
                        // Image and caption
                        overlayImg = document.createElement('img');
                        overlayCaption = document.createElement('div');
                        overlayCaption.className = 'lcplots-overlay-caption';
                        // Place caption above the image
                        content.appendChild(overlayCaption);
                        content.appendChild(overlayImg);
                        overlayEl.appendChild(content);
                        overlayEl.appendChild(closeBtn);
                        overlayEl.appendChild(prevBtn);
                        overlayEl.appendChild(nextBtn);
                        overlayEl.addEventListener('click', (evt) => {
                            // Close when clicking the backdrop only
                            if (evt.target === overlayEl) closeOverlay();
                        });
                        document.body.appendChild(overlayEl);
                    }
                    function openOverlay(index, images) {
                        if (!overlayEl) createOverlay();
                        overlayImages = images || [];
                        document.body.style.overflow = 'hidden';
                        overlayEl.style.display = 'flex';
                        currentIndex = index;
                        showAt(currentIndex, overlayImages);
                        // Keyboard navigation
                        overlayKeyHandler = (evt) => {
                            if (evt.key === 'Escape') {
                                closeOverlay();
                            } else if (evt.key === 'ArrowLeft') {
                                showAt(currentIndex - 1, images);
                            } else if (evt.key === 'ArrowRight') {
                                showAt(currentIndex + 1, images);
                            }
                        };
                        document.addEventListener('keydown', overlayKeyHandler);
                    }
                    function closeOverlay() {
                        if (overlayEl) {
                            overlayEl.style.display = 'none';
                        }
                        document.body.style.overflow = '';
                        if (overlayKeyHandler) {
                            document.removeEventListener('keydown', overlayKeyHandler);
                            overlayKeyHandler = null;
                        }
                    }
                    function showAt(index, images) {
                        if (!images || images.length === 0) return;
                        // Wrap around
                        if (index < 0) index = images.length - 1;
                        if (index >= images.length) index = 0;
                        currentIndex = index;
                        const item = images[currentIndex];
                        if (overlayImg) {
                            overlayImg.src = item.src;
                            overlayImg.alt = item.name || '';
                        }
                        if (overlayCaption) {
                            overlayCaption.textContent = item.name || '';
                        }
                    }
                    // Handle image-link clicks to open overlay gallery
                    list.addEventListener('click', function (e) {
                        const link = e.target && e.target.closest && e.target.closest('a.image-link');
                        if (!link) return;
                        e.preventDefault();
                        e.stopPropagation();
                        const imageLinks = Array.from(list.querySelectorAll('a.image-link'));
                        const images = imageLinks.map(a => ({
                            src: a.getAttribute('data-path') || a.getAttribute('href'),
                            name: a.getAttribute('data-name') || (a.textContent || '').trim()
                        })).filter(img => !!img.src);
                        const clickedIndex = imageLinks.indexOf(link);
                        openOverlay(Math.max(0, clickedIndex), images);
                    });
                    embedPanel.appendChild(shell);
                } catch (e) {
                    console.error('renderLcplotsPage failed', e);
                }
            }

            // Column browser helpers (legacy, unused now but kept for reference)
            function isDirectoryLink(a) {
                if (!a) return false;
                const href = a.getAttribute('href') || '';
                // treat non-image/pdf as directory (lcplots uses directory links without extension)
                return href.startsWith('/hatpi/lcplots') && !/\.(jpg|jpeg|png|gif|pdf|txt|fits)$/i.test(href);
            }
            function extractListContainer(fragment) {
                // Use the entire file-list as a column content
                const list = fragment.querySelector('.lcplots-container .file-list');
                return list ? list.cloneNode(true) : null;
            }
            async function renderLcplotsColumns(url, fragment) {
                embedPanel.innerHTML = '';
                const shell = document.createElement('div');
                shell.className = 'column-browser';
                embedPanel.appendChild(shell);
                // first column
                const firstCol = document.createElement('div');
                firstCol.className = 'column';
                const firstList = extractListContainer(fragment);
                if (firstList) firstCol.appendChild(firstList);
                shell.appendChild(firstCol);
                attachColumnHandlers(firstCol, shell);
            }
            function attachColumnHandlers(columnEl, browserEl) {
                columnEl.addEventListener('click', async (evt) => {
                    const link = evt.target && evt.target.closest && evt.target.closest('a');
                    if (!link) return;
                    const href = link.getAttribute('href') || '';
                    // Skip image overlay links
                    if (link.classList && link.classList.contains('image-link')) return;
                    if (!href.startsWith('/hatpi/lcplots')) return;
                    evt.preventDefault();
                    evt.stopPropagation();
                    // Determine this column index
                    const columns = Array.from(browserEl.querySelectorAll('.column'));
                    const colIndex = columns.indexOf(columnEl);
                    // If directory, fetch and append a new column; else navigate/open as usual
                    if (isDirectoryLink(link)) {
                        // Remove any columns to the right
                        for (let i = columns.length - 1; i > colIndex; i--) {
                            columns[i].remove();
                        }
                        // Fetch next
                        try {
                            const resp = await fetch(href, { credentials: 'same-origin' });
                            if (!resp.ok) return;
                            const html = await resp.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const content = doc.querySelector('.content-wrapper');
                            if (!content) return;
                            const frag = document.createElement('div');
                            frag.innerHTML = content.innerHTML;
                            // prune embedded-only elements if present
                            const header = frag.querySelector('.header'); header && header.remove();
                            const breadcrumb = frag.querySelector('.breadcrumb-nav'); breadcrumb && breadcrumb.remove();
                            const toolbar = frag.querySelector('.lcplots-toolbar'); toolbar && toolbar.remove();
                            const list = extractListContainer(frag);
                            if (!list) return;
                            const newCol = document.createElement('div');
                            newCol.className = 'column';
                            newCol.appendChild(list);
                            browserEl.appendChild(newCol);
                            attachColumnHandlers(newCol, browserEl);
                            // Scroll to the far right to reveal new column
                            browserEl.scrollLeft = browserEl.scrollWidth;
                        } catch (e) {
                            console.error('Column fetch failed', e);
                        }
                    } else {
                        // Non-directory files: default behavior (open link)
                        window.open(href, '_blank');
                    }
                });
            }

            // Global delegated navigation inside embedded lcplots content for all nested levels
            if (embedPanel) {
                embedPanel.addEventListener('click', function (evt) {
                    const link = evt.target && evt.target.closest && evt.target.closest('a');
                    if (!link) return;
                    const lh = link.getAttribute('href') || '';
                    // Skip image overlay links
                    if (link.classList && link.classList.contains('image-link')) return;
                    if (lh.startsWith('/hatpi/lcplots')) {
                        evt.preventDefault();
                        loadIntoEmbed(lh);
                    }
                });
            }

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    if (!homePanel || !embedPanel) return;
                    // Update active state
                    navLinks.forEach(a => a.classList.remove('active'));
                    this.classList.add('active');

                    const href = this.getAttribute('href') || '';
                    if (href === '/hatpi' || href === '/hatpi/') {
                        e.preventDefault();
                        // Show home content
                        embedPanel.style.display = 'none';
                        homePanel.style.display = 'block';
                        return;
                    }

                    // Load other sections inline
                    e.preventDefault();
                    loadIntoEmbed(href).then(ok => {
                        if (ok) {
                            homePanel.style.display = 'none';
                            embedPanel.style.display = 'block';
                        } else {
                            // Fallback: navigate normally if inline load fails
                            window.location.href = href;
                        }
                    });
                });
            });
        });
    </script>
    <script>
        function showTab(tabId, event) {
            // Hide all tab contents
            var tabContents = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }

            // Deactivate all pill buttons
            var pillButtons = document.getElementsByClassName('pill-button-unique');
            for (var i = 0; i < pillButtons.length; i++) {
                pillButtons[i].classList.remove('active');
            }

            // Activate the selected tab and its corresponding button
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');

            // Hide the container div when IHU tab is active
            var containerDiv = document.querySelector('.container');
            var additionalButtons = document.getElementById('additional-buttons');
            if (tabId === 'ihu') {
                containerDiv.style.display = 'none';
                additionalButtons.style.display = 'flex';
                showSequential(event);  // Default to showing the Sequential grid
                document.querySelector('#additional-buttons .pill-button-unique[onclick="showSequential(event)"]').classList.add('active');
            } else {
                containerDiv.style.display = 'block';
                additionalButtons.style.display = 'none';
                document.getElementById('grid-container-ihu-sequential').style.display = 'none';
                document.getElementById('grid-container-ihu-actual').style.display = 'none';
            }
        }

        function showActual(event) {
            document.getElementById('grid-container-ihu-sequential').style.display = 'none';
            document.getElementById('grid-container-ihu-actual').style.display = 'grid';
            event.target.classList.add('active');
            document.querySelector('#additional-buttons .pill-button-unique:not([onclick="showActual(event)"])').classList.remove('active');
        }

        function showSequential(event) {
            document.getElementById('grid-container-ihu-sequential').style.display = 'grid';
            document.getElementById('grid-container-ihu-actual').style.display = 'none';
            event.target.classList.add('active');
            document.querySelector('#additional-buttons .pill-button-unique:not([onclick="showSequential(event)"])').classList.remove('active');
        }

        // JavaScript to create the IHU grids
        document.addEventListener('DOMContentLoaded', function () {
            const sequentialRowColors = ["#D5A6BE", "#B4A7D6", "#CEE1F3", "#6FA7DC", "#77A5AF", "#93C47D", "#F9E499", "#F5B26B", "#E06566", "#CC4125"];
            const sequentialRowColumns = [3, 7, 8, 9, 9, 9, 8, 6, 4, 1];
            const sequentialGridContainer = document.getElementById('grid-container-ihu-sequential');

            let textIndex = 64;  // Starting text index
            for (let i = 0; i < sequentialRowColumns.length; i++) {
                const row = document.createElement('div');
                row.className = 'grid-row-ihu';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = `repeat(${sequentialRowColumns[i]}, 45px)`;
                row.style.justifyContent = 'center';

                const cells = [];
                for (let j = 0; j < sequentialRowColumns[i]; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-item-ihu';
                    cell.style.backgroundColor = sequentialRowColors[i];

                    const button = document.createElement('button');
                    button.textContent = textIndex;

                    // Use an IIFE to create a closure that captures the current value of textIndex
                    (function (index) {
                        button.addEventListener('click', function () {
                            const cellNumber = index.toString().padStart(2, '0');
                            window.location.href = '/hatpi/ihu/ihu-' + cellNumber;
                        });
                    })(textIndex);

                    cell.appendChild(button);
                    textIndex--;
                    cells.unshift(cell); // Add cell to the beginning of the array
                }
                cells.forEach(cell => row.appendChild(cell)); // Append cells to the row
                sequentialGridContainer.appendChild(row); // Append row to the grid container
            }

            // Placeholder grid for "Actual"
            const actualGridContainer = document.getElementById('grid-container-ihu-actual');

            // Function to create merged cells
            function createMergedCell(top, left, width, height, color) {
                const cell = document.createElement('div');
                cell.style.position = 'absolute';
                cell.style.top = top + 'px';
                cell.style.left = left + 'px';
                cell.style.width = width + 'px';
                cell.style.height = height + 'px';
                cell.style.backgroundColor = color;
                // cell.style.border = '1px solid #000';
                return cell;
            }

            // Function to create merged cells
            function createMergedButton(top, left, width, height, text, color, href) {
                const button = document.createElement('button');
                button.className = 'actual-merged-button';
                button.textContent = text;
                button.style.position = 'absolute';
                button.style.top = top + 'px';
                button.style.left = left + 'px';
                button.style.width = width + 'px';
                button.style.height = height + 'px';
                button.style.backgroundColor = color;
                button.style.border = '1px solid #2b333c';
                button.style.fontSize = '1em';
                button.style.cursor = 'pointer';
                button.addEventListener('click', () => {
                    window.location.href = href;
                });
                return button;
            }

            // Add merged buttons to the Actual grid
            actualGridContainer.style.position = 'relative';

            // merged buttons (top, left, width, height)
            const mergedButton61 = createMergedButton(0, 40, 40, 40, '61', '#B4A7D5', '/hatpi/ihu/ihu-61');
            const mergedButton55 = createMergedButton(0, 400, 40, 40, '55', '#B4A7D5', '/hatpi/ihu/ihu-55');

            const mergedButton53 = createMergedButton(60, 40, 40, 40, '53', '#D0E2F3', '/hatpi/ihu/ihu-53');
            const mergedButton60 = createMergedButton(60, 100, 40, 40, '60', '#B4A7D5', '/hatpi/ihu/ihu-60');
            const mergedButton59 = createMergedButton(60, 160, 40, 40, '59', '#B4A7D5', '/hatpi/ihu/ihu-59');
            const mergedButton42 = createMergedButton(60, 220, 40, 40, '42', '#6D9EEB', '/hatpi/ihu/ihu-42');
            const mergedButton57 = createMergedButton(60, 280, 40, 40, '57', '#B4A7D5', '/hatpi/ihu/ihu-57');
            const mergedButton56 = createMergedButton(60, 340, 40, 40, '56', '#B4A7D5', '/hatpi/ihu/ihu-56');
            const mergedButton33 = createMergedButton(60, 400, 40, 40, '33', '#76A5AE', '/hatpi/ihu/ihu-33');

            const mergedButton40 = createMergedButton(120, 100, 40, 40, '40', '#6D9EEB', '/hatpi/ihu/ihu-40');
            const mergedButton64 = createMergedButton(120, 160, 40, 40, '64', '#C27BA0', '/hatpi/ihu/ihu-64');
            const mergedButton63 = createMergedButton(120, 220, 40, 40, '63', '#C27BA0', '/hatpi/ihu/ihu-63');
            const mergedButton62 = createMergedButton(120, 280, 40, 40, '62', '#C27BA0', '/hatpi/ihu/ihu-62');
            const mergedButton58 = createMergedButton(120, 340, 40, 40, '58', '#B4A7D5', '/hatpi/ihu/ihu-58');

            const mergedButton51 = createMergedButton(100, 0, 40, 40, '51', '#D0E2F3', '/hatpi/ihu/ihu-51');
            const mergedButton35 = createMergedButton(160, 0, 40, 40, '35', '#76A5AE', '/hatpi/ihu/ihu-35');
            const mergedButton45 = createMergedButton(220, 0, 40, 40, '45', '#6D9EEB', '/hatpi/ihu/ihu-45');
            const mergedButton26 = createMergedButton(280, 0, 40, 40, '26', '#93C47D', '/hatpi/ihu/ihu-26');
            const mergedButton36 = createMergedButton(340, 0, 40, 40, '36', '#76A5AE', '/hatpi/ihu/ihu-36');
            const mergedButton27 = createMergedButton(400, 0, 40, 40, '27', '#93C47D', '/hatpi/ihu/ihu-27');
            const mergedButton18 = createMergedButton(460, 0, 40, 40, '18', '#ffe598', '/hatpi/ihu/ihu-18');

            const mergedButton54 = createMergedButton(160, 60, 40, 40, '54', '#D0E2F3', '/hatpi/ihu/ihu-54');
            const mergedButton46 = createMergedButton(220, 60, 40, 40, '46', '#6D9EEB', '/hatpi/ihu/ihu-46');
            const mergedButton37 = createMergedButton(280, 60, 40, 40, '37', '#76A5AE', '/hatpi/ihu/ihu-37');
            const mergedButton28 = createMergedButton(340, 60, 40, 40, '28', '#93C47D', '/hatpi/ihu/ihu-28');
            const mergedButton19 = createMergedButton(400, 60, 40, 40, '19', '#ffe598', '/hatpi/ihu/ihu-19');

            const mergedButton47 = createMergedButton(160, 380, 40, 40, '47', '#D0E2F3', '/hatpi/ihu/ihu-47');
            const mergedButton38 = createMergedButton(220, 380, 40, 40, '38', '#6D9EEB', '/hatpi/ihu/ihu-38');
            const mergedButton29 = createMergedButton(280, 380, 40, 40, '29', '#76A5AE', '/hatpi/ihu/ihu-29');
            const mergedButton20 = createMergedButton(340, 380, 40, 40, '20', '#93C47D', '/hatpi/ihu/ihu-20');
            const mergedButton12 = createMergedButton(400, 380, 40, 40, '12', '#ffe598', '/hatpi/ihu/ihu-12');

            const mergedButton11 = createMergedButton(440, 100, 40, 40, '11', '#F6B26B', '/hatpi/ihu/ihu-11');
            const mergedButton5 = createMergedButton(440, 160, 40, 40, '5', '#E06666', '/hatpi/ihu/ihu-05');
            const mergedButton24 = createMergedButton(440, 220, 40, 40, '24', '#93C47D', '/hatpi/ihu/ihu-24');
            const mergedButton2 = createMergedButton(440, 280, 40, 40, '2', '#E06666', '/hatpi/ihu/ihu-02');
            const mergedButton6 = createMergedButton(440, 340, 40, 40, '6', '#F6B26B', '/hatpi/ihu/ihu-06');

            const mergedButton48 = createMergedButton(100, 440, 40, 40, '48', '#D0E2F3', '/hatpi/ihu/ihu-48');
            const mergedButton31 = createMergedButton(160, 440, 40, 40, '31', '#76A5AE', '/hatpi/ihu/ihu-31');
            const mergedButton39 = createMergedButton(220, 440, 40, 40, '39', '#6D9EEB', '/hatpi/ihu/ihu-39');
            const mergedButton22 = createMergedButton(280, 440, 40, 40, '22', '#93C47D', '/hatpi/ihu/ihu-22');
            const mergedButton30 = createMergedButton(340, 440, 40, 40, '30', '#76A5AE', '/hatpi/ihu/ihu-30');
            const mergedButton21 = createMergedButton(400, 440, 40, 40, '21', '#93C47D', '/hatpi/ihu/ihu-21');
            const mergedButton13 = createMergedButton(460, 440, 40, 40, '13', '#ffe598', '/hatpi/ihu/ihu-13');

            const mergedButton10 = createMergedButton(500, 40, 40, 40, '10', '#F6B26B', '/hatpi/ihu/ihu-10');
            const mergedButton9 = createMergedButton(500, 100, 40, 40, '9', '#F6B26B', '/hatpi/ihu/ihu-09');
            const mergedButton4 = createMergedButton(500, 160, 40, 40, '4', '#E06666', '/hatpi/ihu/ihu-04');
            const mergedButton1 = createMergedButton(500, 220, 40, 40, '1', '#CD4025', '/hatpi/ihu/ihu-01');
            const mergedButton3 = createMergedButton(500, 280, 40, 40, '3', '#E06666', '/hatpi/ihu/ihu-03');
            const mergedButton8 = createMergedButton(500, 340, 40, 40, '8', '#F6B26B', '/hatpi/ihu/ihu-08');
            const mergedButton7 = createMergedButton(500, 400, 40, 40, '7', '#F6B26B', '/hatpi/ihu/ihu-07');

            const mergedButton44 = createMergedButton(180, 160, 40, 40, '44', '#6D9EEB', '/hatpi/ihu/ihu-44');
            const mergedButton50 = createMergedButton(180, 220, 40, 40, '50', '#D0E2F3', '/hatpi/ihu/ihu-50');
            const mergedButton49 = createMergedButton(180, 280, 40, 40, '49', '#D0E2F3', '/hatpi/ihu/ihu-49');

            const mergedButton52 = createMergedButton(220, 120, 40, 40, '52', '#D0E2F3', '/hatpi/ihu/ihu-52');
            const mergedButton43 = createMergedButton(280, 120, 40, 40, '43', '#6D9EEB', '/hatpi/ihu/ihu-43');
            const mergedButton25 = createMergedButton(340, 120, 40, 40, '25', '#93C47D', '/hatpi/ihu/ihu-25');

            const mergedButton17 = createMergedButton(380, 160, 40, 40, '17', '#ffe598', '/hatpi/ihu/ihu-17');
            const mergedButton16 = createMergedButton(380, 220, 40, 40, '16', '#ffe598', '/hatpi/ihu/ihu-16');
            const mergedButton15 = createMergedButton(380, 280, 40, 40, '15', '#ffe598', '/hatpi/ihu/ihu-15');

            const mergedButton41 = createMergedButton(220, 320, 40, 40, '41', '#6D9EEB', '/hatpi/ihu/ihu-41');
            const mergedButton23 = createMergedButton(280, 320, 40, 40, '23', '#93C47D', '/hatpi/ihu/ihu-23');
            const mergedButton14 = createMergedButton(340, 320, 40, 40, '14', '#ffe598', '/hatpi/ihu/ihu-14');

            const mergedButton34 = createMergedButton(560, 140, 40, 40, '34', '#76A5AE', '/hatpi/ihu/ihu-34');
            const mergedButton32 = createMergedButton(560, 300, 40, 40, '32', '#76A5AE', '/hatpi/ihu/ihu-32');


            // grey outer frame (top, left, width, height)
            const frame1 = createMergedCell(60, 0, 480, 40, '#2b333c',); //top
            const frame2 = createMergedCell(60, 0, 40, 480, '#2b333c',); //left
            const frame3 = createMergedCell(500, 0, 480, 40, '#2b333c',); //bottom
            const frame4 = createMergedCell(60, 440, 40, 480, '#2b333c',); //right

            // grey middle frame (top, left, width, height)
            const frame5 = createMergedCell(120, 60, 360, 40, '#2b333c'); //top
            const frame6 = createMergedCell(120, 60, 40, 360, '#2b333c'); //left
            const frame7 = createMergedCell(440, 60, 360, 40, '#2b333c'); //bottom
            const frame8 = createMergedCell(120, 380, 40, 360, '#2b333c'); //right

            // grey inner frame (top, left, width, height)
            const frame9 = createMergedCell(180, 120, 240, 40, '#2b333c'); //top
            const frame10 = createMergedCell(180, 120, 40, 240, '#2b333c'); //left
            const frame11 = createMergedCell(380, 120, 240, 40, '#2b333c'); //bottom
            const frame12 = createMergedCell(180, 320, 40, 240, '#2b333c'); //right


            // grey top/bottom legs of frame (top, left, width, height)
            const frame13 = createMergedCell(0, 40, 40, 100, '#2b333c'); //top-left
            const frame14 = createMergedCell(0, 400, 40, 100, '#2b333c'); //top-right
            const frame15 = createMergedCell(500, 140, 40, 100, '#2b333c'); //bottom-left
            const frame16 = createMergedCell(500, 300, 40, 100, '#2b333c',); //bottom-right


            //grey frames
            actualGridContainer.appendChild(frame1);
            actualGridContainer.appendChild(frame2);
            actualGridContainer.appendChild(frame3);
            actualGridContainer.appendChild(frame4);

            actualGridContainer.appendChild(frame5);
            actualGridContainer.appendChild(frame6);
            actualGridContainer.appendChild(frame7);
            actualGridContainer.appendChild(frame8);

            actualGridContainer.appendChild(frame9);
            actualGridContainer.appendChild(frame10);
            actualGridContainer.appendChild(frame11);
            actualGridContainer.appendChild(frame12);

            actualGridContainer.appendChild(frame13);
            actualGridContainer.appendChild(frame14);
            actualGridContainer.appendChild(frame15);
            actualGridContainer.appendChild(frame16);



            //IHU buttons

            actualGridContainer.appendChild(mergedButton61);
            actualGridContainer.appendChild(mergedButton55);

            actualGridContainer.appendChild(mergedButton53);
            actualGridContainer.appendChild(mergedButton60);
            actualGridContainer.appendChild(mergedButton59);
            actualGridContainer.appendChild(mergedButton42);
            actualGridContainer.appendChild(mergedButton57);
            actualGridContainer.appendChild(mergedButton56);
            actualGridContainer.appendChild(mergedButton33);

            actualGridContainer.appendChild(mergedButton40);
            actualGridContainer.appendChild(mergedButton64);
            actualGridContainer.appendChild(mergedButton63);
            actualGridContainer.appendChild(mergedButton62);
            actualGridContainer.appendChild(mergedButton58);

            actualGridContainer.appendChild(mergedButton51);
            actualGridContainer.appendChild(mergedButton35);
            actualGridContainer.appendChild(mergedButton45);
            actualGridContainer.appendChild(mergedButton26);
            actualGridContainer.appendChild(mergedButton36);
            actualGridContainer.appendChild(mergedButton27);
            actualGridContainer.appendChild(mergedButton18);

            actualGridContainer.appendChild(mergedButton54);
            actualGridContainer.appendChild(mergedButton46);
            actualGridContainer.appendChild(mergedButton37);
            actualGridContainer.appendChild(mergedButton28);
            actualGridContainer.appendChild(mergedButton19);

            actualGridContainer.appendChild(mergedButton47);
            actualGridContainer.appendChild(mergedButton38);
            actualGridContainer.appendChild(mergedButton29);
            actualGridContainer.appendChild(mergedButton20);
            actualGridContainer.appendChild(mergedButton12);

            actualGridContainer.appendChild(mergedButton11);
            actualGridContainer.appendChild(mergedButton5);
            actualGridContainer.appendChild(mergedButton24);
            actualGridContainer.appendChild(mergedButton2);
            actualGridContainer.appendChild(mergedButton6);

            actualGridContainer.appendChild(mergedButton48);
            actualGridContainer.appendChild(mergedButton31);
            actualGridContainer.appendChild(mergedButton39);
            actualGridContainer.appendChild(mergedButton22);
            actualGridContainer.appendChild(mergedButton30);
            actualGridContainer.appendChild(mergedButton21);
            actualGridContainer.appendChild(mergedButton13);

            actualGridContainer.appendChild(mergedButton10);
            actualGridContainer.appendChild(mergedButton9);
            actualGridContainer.appendChild(mergedButton4);
            actualGridContainer.appendChild(mergedButton1);
            actualGridContainer.appendChild(mergedButton3);
            actualGridContainer.appendChild(mergedButton8);
            actualGridContainer.appendChild(mergedButton7);

            actualGridContainer.appendChild(mergedButton44);
            actualGridContainer.appendChild(mergedButton50);
            actualGridContainer.appendChild(mergedButton49);

            actualGridContainer.appendChild(mergedButton52);
            actualGridContainer.appendChild(mergedButton43);
            actualGridContainer.appendChild(mergedButton25);

            actualGridContainer.appendChild(mergedButton17);
            actualGridContainer.appendChild(mergedButton16);
            actualGridContainer.appendChild(mergedButton15);

            actualGridContainer.appendChild(mergedButton41);
            actualGridContainer.appendChild(mergedButton23);
            actualGridContainer.appendChild(mergedButton14);

            actualGridContainer.appendChild(mergedButton34);
            actualGridContainer.appendChild(mergedButton32);





        });
    </script>
    <script>
        function toggleCommentsTagged(view, event) {
            if (event) event.preventDefault();

            const currentScroll = window.pageYOffset;
            if (view === 'comments') {
                document.getElementById('comments-container').style.display = 'grid';
                document.getElementById('taggedImagesContainer').style.display = 'none';
                document.getElementById('show-comments').classList.add('active');
                document.getElementById('show-tagged').classList.remove('active');
            } else if (view === 'tagged') {
                document.getElementById('comments-container').style.display = 'none';
                document.getElementById('taggedImagesContainer').style.display = 'block';
                document.getElementById('show-comments').classList.remove('active');
                document.getElementById('show-tagged').classList.add('active');
                loadTaggedImages(); // load the tagged images when view is switched
            }

            setTimeout(() => {
                window.scrollTo(0, currentScroll);
            }, 0);

        }

    </script>
    <script>
        // This function is only for the flagged overlay in index.html.
        function highlightActiveFlaggedItemIndex(linkElement) {
            // Find the flagged group container that this link is in.
            const groupCard = linkElement.closest('.tagged-flag-card');

            // Remove active styling from flagged items only in this group.
            groupCard.querySelectorAll('.tagged-item').forEach(item => {
                item.classList.remove('active-index');
            });

            // Add active styling to the flagged item of this link.
            const parentItem = linkElement.closest('.tagged-item');
            if (parentItem) {
                parentItem.classList.add('active-index');
                parentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }


        // Example: update your click handler in loadTaggedImages().
        // In your loadTaggedImages() function (where flagged links are created), ensure that each
        // flagged link gets a data-index attribute. Then, attach the click handler:
        document.addEventListener('DOMContentLoaded', function () {
            const taggedLinks = document.querySelectorAll('#taggedImagesContainer .tagged-file-link');
            taggedLinks.forEach((link, index) => {
                // Ensure a data-index is set if not already.
                link.setAttribute('data-index', index);
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    // Your existing logic to open the flagged overlay...
                    // Then, call the new highlighting function:
                    highlightActiveFlaggedItemIndex(link);
                    // (If you already have a function like openFlaggedGallery() that takes an index,
                    // you can also pass 'link' to it so that it uses this new highlight function.)
                });
            });
        });
    </script>



</body>

</html>